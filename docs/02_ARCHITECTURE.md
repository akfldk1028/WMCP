# 02. WebMCP 전체 아키텍처

## 시스템 구조 개요

WebMCP의 전체 아키텍처를 한눈에 보면 이렇다:

```
+------------------------------------------------------------------+
|                         브라우저                                   |
|                                                                    |
|  +---------------------+         +----------------------------+   |
|  |   브라우저 에이전트    |         |       웹 페이지 (탭)         |   |
|  |   (AI 어시스턴트)     |         |                            |   |
|  |                     |         |  navigator.modelContext     |   |
|  |  - 사용자 채팅 UI    |  도구   |    .provideContext({        |   |
|  |  - LLM 추론 엔진    |<------->|      tools: [...]           |   |
|  |  - 도구 호출 결정    |  호출   |    })                       |   |
|  |  - 결과 해석        |  /응답   |                            |   |
|  |                     |         |  기존 JS 비즈니스 로직       |   |
|  +---------------------+         |    - addStamp()             |   |
|           ^                      |    - filterTemplates()      |   |
|           |                      |    - editDesign()           |   |
|           v                      +----------------------------+   |
|  +---------------------+                                          |
|  |      사용자          |                                          |
|  |  (채팅 + 웹 UI)     |                                          |
|  +---------------------+                                          |
+------------------------------------------------------------------+
```

### 핵심 포인트

- **모든 것이 브라우저 안에서** 일어남 (외부 서버 불필요)
- **사용자와 에이전트가 같은 웹 페이지**를 본다
- **브라우저가 중재자** 역할 (권한 관리, 도구 호출 라우팅)

---

## 계층별 아키텍처

### Layer 1: 웹 페이지 (Tool Provider)

웹 페이지는 `navigator.modelContext` API를 통해 도구를 등록한다.

```
+-----------------------------------------------+
|                 웹 페이지                        |
|                                                 |
|  [HTML/CSS UI]  <--->  [JavaScript 로직]         |
|                            |                    |
|                   +--------+--------+           |
|                   |                 |           |
|            기존 함수들         WebMCP 등록        |
|           addStamp()      provideContext()       |
|           editDesign()    registerTool()         |
|           getDresses()    unregisterTool()       |
|                   |                 |           |
|                   +--------+--------+           |
|                            |                    |
|                   execute 콜백에서               |
|                   기존 함수 호출                  |
+-----------------------------------------------+
```

**동작 흐름**:
1. 페이지 로드 시 `navigator.modelContext.provideContext()` 호출
2. 도구 목록(이름, 설명, 스키마, 실행 콜백)을 브라우저에 등록
3. SPA에서 상태 변화 시 도구 목록을 동적으로 갱신 가능
4. 도구 호출 시 `execute` 콜백이 실행되어 기존 비즈니스 로직 실행

### Layer 2: 브라우저 (Mediator)

브라우저는 도구 제공자(웹 페이지)와 소비자(에이전트) 사이의 중재자다.

```
+---------------------------------------------------+
|                    브라우저 프로세스                   |
|                                                     |
|  +-------------+   +------------+   +------------+  |
|  | 권한 관리    |   | 도구 레지스트리|   | 라우팅     |  |
|  |             |   |            |   |            |  |
|  | - 사이트가   |   | - 등록된    |   | - 어느 탭의 |  |
|  |   도구 등록  |   |   도구 목록  |   |   도구를   |  |
|  |   할 때 허용? |   |   관리     |   |   호출할지  |  |
|  |             |   |            |   |   결정     |  |
|  | - 에이전트가 |   | - 도구 이름  |   |            |  |
|  |   도구 호출  |   |   충돌 해결  |   | - SW vs   |  |
|  |   할 때 허용? |   |            |   |   탭 라우팅 |  |
|  +-------------+   +------------+   +------------+  |
+---------------------------------------------------+
```

**브라우저의 책임**:
1. **권한 관리**: 사이트가 도구를 등록할 때, 에이전트가 도구를 호출할 때 각각 사용자 동의 필요
2. **도구 레지스트리**: 어떤 탭/SW가 어떤 도구를 제공하는지 추적
3. **라우팅**: 에이전트의 도구 호출 요청을 올바른 페이지/SW에 전달
4. **MCP 프로토콜 버전 관리**: MCP 버전이 바뀌어도 하위 호환성 유지

### Layer 3: 에이전트 (Tool Consumer)

에이전트는 등록된 도구를 활용하여 사용자의 목표를 달성한다.

```
+-----------------------------------------------+
|                   에이전트                       |
|                                                 |
|  사용자 프롬프트                                  |
|       |                                         |
|       v                                         |
|  [LLM 추론 엔진]                                 |
|       |                                         |
|       +-- 도구 목록 조회 (어떤 도구가 있나?)       |
|       |                                         |
|       +-- 도구 선택 (어떤 도구가 적합한가?)        |
|       |     - 도구 이름, 설명, 스키마를 보고 판단   |
|       |                                         |
|       +-- 도구 호출 (파라미터 생성 & 호출)         |
|       |     - inputSchema에 맞는 인자 생성        |
|       |     - 브라우저를 통해 execute 콜백 호출     |
|       |                                         |
|       +-- 결과 해석 (반환값을 대화에 통합)          |
|       |                                         |
|       v                                         |
|  사용자에게 응답                                   |
+-----------------------------------------------+
```

---

## 데이터 흐름 (Sequence Diagram)

### 기본 도구 호출 흐름

```
사용자          에이전트           브라우저          웹 페이지
  |               |                 |                |
  |  "우표 추가해줘" |                |                |
  |-------------->|                 |                |
  |               |                 |                |
  |               | 도구 목록 확인    |                |
  |               |---------------->|                |
  |               |                 |                |
  |               | tools: [{       |                |
  |               |   name:"add-stamp"|              |
  |               |   description:...|               |
  |               |   inputSchema:...|               |
  |               | }]              |                |
  |               |<----------------|                |
  |               |                 |                |
  |               | add-stamp 호출   |                |
  |               | {name:"...",    |                |
  |               |  year:2024}     |                |
  |               |---------------->|                |
  |               |                 | execute() 호출  |
  |               |                 |--------------->|
  |               |                 |                |
  |               |                 |    addStamp()  |
  |               |                 |    UI 갱신     |
  |               |                 |                |
  |               |                 | 결과 반환       |
  |               |                 |<---------------|
  |               | 도구 결과        |                |
  |               |<----------------|                |
  |               |                 |                |
  | "우표가 추가됨" |                |                |
  |<--------------|                 |                |
```

### 사용자 상호작용 요청 흐름 (requestUserInteraction)

```
사용자          에이전트           브라우저          웹 페이지
  |               |                 |                |
  |  "이 상품 사줘" |                |                |
  |-------------->|                 |                |
  |               |                 |                |
  |               | buyProduct 호출  |                |
  |               |---------------->|                |
  |               |                 | execute() 호출  |
  |               |                 |--------------->|
  |               |                 |                |
  |               |                 |  requestUser   |
  |               |                 |  Interaction() |
  |               |                 |<---------------|
  |               |                 |                |
  |  "정말 구매?"  |                 |                |
  |<---------------------------------|               |
  |                                  |               |
  |  "네, 구매합니다"                  |               |
  |--------------------------------->|               |
  |               |                 |                |
  |               |                 | 확인 결과 전달   |
  |               |                 |--------------->|
  |               |                 |                |
  |               |                 | 구매 실행       |
  |               |                 | 결과 반환       |
  |               |                 |<---------------|
  |               |<----------------|                |
  | "구매 완료"    |                 |                |
  |<--------------|                 |                |
```

---

## 도구 등록 생명주기

### 1단계: 페이지 로드 시 도구 등록

```
페이지 로드
    |
    v
navigator.modelContext 존재 확인
    |
    +-- 미지원 브라우저 --> 무시 (graceful degradation)
    |
    +-- 지원 브라우저
         |
         v
    provideContext({ tools: [...] })
         |
         v
    브라우저가 도구 목록 저장
         |
         v
    에이전트에게 도구 목록 갱신 알림
```

### 2단계: SPA에서 동적 도구 갱신

```
사용자가 페이지 내 상태 변경 (예: 디자인 편집 모드 진입)
    |
    v
방법 A: provideContext() 다시 호출
    |   (기존 도구 전부 클리어 후 새로 등록)
    |
    또는
    |
방법 B: registerTool() / unregisterTool() 개별 호출
    |   (기존 도구는 유지하고 추가/제거만)
    |
    v
브라우저 도구 레지스트리 갱신
    |
    v
에이전트에게 변경 알림
```

### 3단계: 페이지 종료 시 도구 해제

```
탭 닫기 / 페이지 이동
    |
    v
등록된 도구 모두 자동 해제
    |
    v
(Service Worker 확장이 없으면 도구 사라짐)
```

---

## 아키텍처 설계 결정과 근거

### 왜 메인 스레드에서 도구를 처리하나?

| 결정 | 메인 스레드에서 execute 콜백 실행 |
|------|------|
| **근거 1** | 도구 호출이 순차적/직렬로 실행됨을 보장 |
| **근거 2** | UI 갱신이 즉시 가능 (DOM 접근) |
| **근거 3** | 단순한 앱은 별도 워커 없이 바로 구현 가능 |
| **대안** | 무거운 작업은 개발자가 직접 Dedicated Worker에 위임 가능 |

### 왜 top-level browsing context만 허용하나?

| 결정 | iframe이 아닌 최상위 탭만 도구 제공 가능 |
|------|------|
| **근거** | iframe에서 도구를 등록하면 보안 경계가 복잡해짐 |
| **영향** | 임베딩된 third-party 콘텐츠가 도구를 등록할 수 없음 |

### 왜 MCP를 직접 구현하지 않고 자체 API를 만들었나?

| 결정 | MCP 프리미티브에 정렬하되, MCP 프로토콜 자체를 구현하지는 않음 |
|------|------|
| **근거 1** | MCP가 아직 활발히 변하고 있어 맞추기가 ongoing effort |
| **근거 2** | 비-LLM 시나리오(OS 어시스턴트, 접근성 도구)도 지원하려면 MCP에 tight coupling하면 안 됨 |
| **근거 3** | 브라우저가 MCP 버전 변경에 대한 하위 호환성을 관리할 수 있음 |
| **결과** | WebMCP 도구는 MCP 도구로 쉽게 변환 가능하지만, 1:1 매핑은 아님 |

---

## 3가지 아키텍처 토폴로지

### 토폴로지 1: 단일 탭 + 온페이지 도구 (기본)

```
+------------------+     +------------------+
|    에이전트       |<--->|   탭 (페이지 A)   |
|   (사이드바 등)   |     |   tools: [...]   |
+------------------+     +------------------+
```

가장 단순한 구조. 1:1 매핑.

### 토폴로지 2: Service Worker만

```
+------------------+     +------------------+
|    에이전트 1     |<--->|                  |
+------------------+     |  Service Worker  |
                         |  tools: [...]    |
+------------------+     |                  |
|    에이전트 2     |<--->|                  |
+------------------+     +------------------+
```

UI 없이 백그라운드에서 도구 실행. 여러 에이전트가 같은 SW에 연결 가능.

### 토폴로지 3: 탭 + Service Worker (복합)

```
+------------------+     +------------------+
|                  |<--->|   탭 (페이지 A)   |
|    에이전트       |     |   tools: [x, y]  |
|                  |     +------------------+
|                  |
|                  |     +------------------+
|                  |<--->|  Service Worker  |
|                  |     |   tools: [x, z]  |
+------------------+     +------------------+
```

같은 이름의 도구가 탭과 SW에 둘 다 있으면? -> 에이전트가 컨텍스트를 보고 판단하거나 사용자에게 물어봄.

---

## 신뢰 경계 (Trust Boundaries)

```
+------------------------------------------------------------------+
|                                                                    |
|  사용자 신뢰 영역                                                   |
|  +--------------------------------------------------------------+ |
|  |                                                              | |
|  |  브라우저 신뢰 영역                                            | |
|  |  +---------------------------+  +---------------------------+| |
|  |  |     에이전트 영역          |  |     웹 페이지 영역         || |
|  |  |                           |  |                           || |
|  |  |  - 사용자 개인화 데이터     |  |  - 도구 등록              || |
|  |  |  - 크로스사이트 컨텍스트    |  |  - 도구 실행              || |
|  |  |  - LLM 추론 결과          |  |  - 반환값 생성             || |
|  |  |                           |  |                           || |
|  |  +---------------------------+  +---------------------------+| |
|  |                                                              | |
|  |  [신뢰 경계 1] 사이트 -> 브라우저: 도구 등록 시 정보 노출       | |
|  |  [신뢰 경계 2] 에이전트 -> 사이트: 도구 호출 시 비신뢰 입력     | |
|  |  [신뢰 경계 3] 사이트 -> 에이전트: 반환값에 민감 정보 포함 가능  | |
|  +--------------------------------------------------------------+ |
|                                                                    |
+------------------------------------------------------------------+
```

브라우저는 두 신뢰 경계에서 사용자 동의를 받아야 한다:
1. **도구 등록 시**: 사이트가 자신의 기능 정보를 에이전트에게 노출
2. **도구 호출 시**: 에이전트가 사이트에 비신뢰 입력을 보내고, 사이트가 민감 데이터를 반환할 수 있음
